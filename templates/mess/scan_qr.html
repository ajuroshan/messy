{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
    <div class="container">
        <h1 class="text-center my-4">Scan QR Code to Mark Attendance</h1>
        <div class="d-flex justify-content-center mb-4">
            <div id="qr-reader" style="width:100%"></div>
        </div>
        <div id="qr-reader-results" class="text-center mb-4"></div>

        <form id="qr-form" class="text-center">
            {% csrf_token %}
            <input type="hidden" name="qr_code_data" id="qr_code_data">
            <input type="number" name="mess_no" placeholder="Enter Mess No (optional)" class="form-control mb-3"
                   style="max-width: 300px; margin: 0 auto;">
            <button type="button" class="btn btn-primary">Enter
            </button>
        </form>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true"
         data-bs-backdrop="false">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">Confirm Attendance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    Are you sure you want to mark attendance with the QR Code and Mess No provided?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="confirmSubmit">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function onScanSuccess(qrMessage) {
            document.getElementById('qr_code_data').value = qrMessage;
            console.log(qrMessage);

            // Prepare the form data for submission
            const form = document.getElementById('qr-form');
            const formData = new FormData(form);

            // Fetch data to display in the modal
            fetch("{% url 'mark_attendance' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
                .then(response => response.json())
                .then(data => {
                    const modalBody = document.getElementById('modalBody');
                    if (data.status === 'success' || data.status === 'have_messcut' || data.status === 'have_messduty') {
                        modalBody.textContent = data.message;
                    } else {
                        modalBody.textContent = data.message;
                    }
                    // Show the modal
                    const modal = new bootstrap.Modal(document.getElementById('confirmModal'), {
                        backdrop: false
                    });
                    modal.show();

                    // Handle the confirmation button click
                    document.getElementById('confirmSubmit').addEventListener('click', function () {
                        formData.append('confirm', 'true');  // Append confirmation flag to form data

                        fetch("{% url 'mark_attendance' %}", {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                            }
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    console.log(data.message); // You might want to use a more elegant notification
                                } else {
                                    console.log(data.message); // You might want to use a more elegant notification
                                }
                                modal.hide(); // Hide the modal after submission
                                form.reset();
                                document.getElementById('qr_code_data').value = '';

                            })
                            .catch(error => {
                                console.error('Error:', error);
                                console.log('An error occurred. Please try again.');
                            });
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    const modalBody = document.getElementById('modalBody');
                    modalBody.textContent = 'An error occurred. Please try again.';
                    const modal = new bootstrap.Modal(document.getElementById('confirmModal'), {
                        backdrop: false
                    });
                    modal.show();
                });
        }


        document.querySelector('button[type="button"]').addEventListener('click', function () {
            // Prepare the form data for submission
            const form = document.getElementById('qr-form');
            const formData = new FormData(form);

            // Fetch data to display in the modal
            fetch("{% url 'mark_attendance' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
                .then(response => response.json())
                .then(data => {
                    const modalBody = document.getElementById('modalBody');
                    if (data.status === 'success' || data.status === 'have_messcut' || data.status === 'have_messduty') {
                        modalBody.textContent = data.message;
                    } else {
                        modalBody.textContent = data.message;
                    }

                    // Show the modal
                    const modal = new bootstrap.Modal(document.getElementById('confirmModal'), {
                        backdrop: false
                    });
                    modal.show();

                    // Handle the confirmation button click
                    document.getElementById('confirmSubmit').addEventListener('click', function () {
                        formData.append('confirm', 'true');  // Append confirmation flag to form data

                        fetch("{% url 'mark_attendance' %}", {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                            }
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    console.log(data.message); // You might want to use a more elegant notification
                                } else {
                                    console.log(data.message); // You might want to use a more elegant notification
                                }
                                modal.hide(); // Hide the modal after submission
                                form.reset();
                                document.getElementById('qr_code_data').value = '';

                            })
                            .catch(error => {
                                console.error('Error:', error);
                                console.log('An error occurred. Please try again.');
                            });
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    const modalBody = document.getElementById('modalBody');
                    modalBody.textContent = 'An error occurred. Please try again.';
                    const modal = new bootstrap.Modal(document.getElementById('confirmModal'), {
                        backdrop: false
                    });
                    modal.show();
                });
        });


        function onScanError(errorMessage) {
            console.error(errorMessage);
            // handle scan error
        }

        let html5QrcodeScanner = new Html5QrcodeScanner(
            "qr-reader", {fps: 5, qrbox: 250});
        html5QrcodeScanner.render(onScanSuccess, onScanError);


    </script>
{% endblock %}